{% extends 'base.html' %}
{% block title %}Турнирная сетка{% endblock %}
{% block styles_extra %}
  <style>
    .bracket { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(220px, 1fr); gap: 16px; overflow-x: auto; padding-bottom: 8px; }
    .round { display: grid; align-content: start; gap: 12px; }
    .match { background: rgba(15,23,42,0.7); border:1px solid var(--border); border-radius: 12px; padding: 10px; }
    .slot { display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; border:1px dashed var(--border); }
    .slot.empty { opacity: .6; font-style: italic; }
    .slot .avatar { width:28px; height:28px; border-radius:6px; border:1px solid var(--border); object-fit: cover; }
    .slot .name { font-weight:700; }
    .winner { border-color: rgba(37,99,235,0.6); box-shadow: inset 0 0 0 1px rgba(37,99,235,0.3); }
  </style>
{% endblock %}
{% block content %}
  <div class="topbar">
    <h1 class="headline">Турнирная сетка</h1>
    <div class="muted">Просмотр</div>
  </div>

  {% if not view %}
    <p class="muted">Сетка ещё не создана. Обратитесь к администратору.</p>
  {% else %}
    <div id="bracket" class="bracket" aria-live="polite"></div>
    <script>
      (function(){
        var last = {{ UPDATED_AT|tojson }};
        var root = document.getElementById('bracket');
        function render(view){
          if (!root) return;
          if (!view || !view.rounds) { root.innerHTML = '<p class="muted">Сетка ещё не создана.</p>'; return; }
          var html = '';
          for (var r=0; r<view.rounds.length; r++){
            var rnd = view.rounds[r];
            html += '<div class="round">';
            html += '<div class="muted">Раунд ' + (r+1) + '</div>';
            for (var i=0; i<rnd.length; i++){
              var m = rnd[i];
              html += '<div class="match">';
              html += '<div class="muted" style="font-size:12px; margin-bottom:6px;">Стол №' + (m.table || '?') + '</div>';
              // p1
              var p1Empty = !m.p1;
              html += '<div class="slot ' + (m.winner==1? 'winner ': '') + (p1Empty? 'empty': '') + '">';
              if (m.p1){
                html += '<img class="avatar" src="' + {{ url_for('static', filename='uploads/__FILE__')|tojson }}.replace('__FILE__', m.p1.photo_filename || '') + '" alt="">';
                html += '<div class="name">' + (m.p1.last_name||'') + ' ' + (m.p1.first_name||'') + '</div>';
              } else {
                html += '<div class="name">—</div>';
              }
              html += '</div>';
              // p2
              var p2Empty = !m.p2;
              html += '<div class="slot ' + (m.winner==2? 'winner ': '') + (p2Empty? 'empty': '') + '" style="margin-top:6px;">';
              if (m.p2){
                html += '<img class="avatar" src="' + {{ url_for('static', filename='uploads/__FILE__')|tojson }}.replace('__FILE__', m.p2.photo_filename || '') + '" alt="">';
                html += '<div class="name">' + (m.p2.last_name||'') + ' ' + (m.p2.first_name||'') + '</div>';
              } else {
                html += '<div class="name">—</div>';
              }
              html += '</div>';
              html += '</div>';
            }
            html += '</div>';
          }
          root.innerHTML = html;
        }
        function poll(){
          fetch('{{ url_for('public_bracket_json') }}', { cache: 'no-store' })
            .then(function(r){ return r.json(); })
            .then(function(d){
              if (!last) { last = d.updated_at; render(d.view); return; }
              if (d && d.updated_at && d.updated_at !== last) {
                last = d.updated_at;
                render(d.view);
              }
            })
            .catch(function(){})
            .finally(function(){ setTimeout(poll, 2000); });
        }
        // initial render
        render({{ view|tojson }});
        setTimeout(poll, 2000);
      })();
    </script>
  {% endif %}
{% endblock %}


